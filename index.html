<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Focus v9</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #161b2c; --primary: #00d2ff; --success: #00ff87; --text: #e2e8f0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; display: flex; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 500px; position: relative; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .total-bar { height: 10px; background: #2d3748; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: 1s ease; }
        .subject-box { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #2d3748; }
        .subject-box.done { border-left-color: var(--success); background: rgba(0, 255, 135, 0.05); }
        .subject-main { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .extra-item { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
        .input-konu { background: #0b0f1a; border: 1px solid #2d3748; color: white; border-radius: 6px; padding: 6px; flex: 1; font-size: 0.8rem; }
        .input-soru { width: 50px; background: #0b0f1a; border: 1px solid var(--primary); color: var(--primary); border-radius: 6px; text-align: center; padding: 6px; }
        .btn-plus { background: var(--primary); border: none; color: black; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-weight: bold; }
        .vakit-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 5px; text-align: center; font-size: 0.7rem; }
        .vakit-box b { color: var(--primary); display: block; font-size: 0.9rem; }
        .btn-action { width: 100%; background: var(--primary); border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; color: #0b0f1a; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-flex">
            <h2 style="margin:0; font-size: 1.2rem;">ðŸš€ Hedef Takibi</h2>
            <div id="perc-text" style="color:var(--success); font-weight:bold;">%0</div>
        </div>
        <div class="total-bar"><div id="main-bar" class="bar-fill"></div></div>
        <button class="btn-action" style="margin-bottom: 15px; background: #22c55e; color: white;" onclick="app.sendTelegram('âœ… Test BaÅŸarÄ±lÄ±! Telefonun baÄŸlandÄ±.')">ðŸ“± Telefona Test GÃ¶nder</button>
        <div id="subject-list"></div>
        <button onclick="app.addSubject()" style="width:100%; background:none; border:1px dashed #4a5568; color:var(--text); padding:10px; border-radius:10px; cursor:pointer;">+ Yeni Ders Ekle</button>
    </div>

    <div class="card">
        <h3 style="margin-top:0; font-size: 1rem;">ðŸ•Œ Namaz Vakitleri</h3>
        <div id="vakit-display" class="vakit-grid"></div>
    </div>
</div>

<script>
const app = {
    config: {
        token: '8138285855:AAGr2aXr_VZa8Skd8q-F13gmolivLo0bL8M',
        chatId: '8035991672'
    },
    state: {
        subjects: [
            { id: 1, name: 'Matematik', mainDone: false, extras: [] },
            { id: 2, name: 'TÃ¼rkÃ§e', mainDone: false, extras: [] },
            { id: 3, name: 'Fen Bilimleri', mainDone: false, extras: [] }
        ],
        vakitler: {},
        lastReset: new Date().toLocaleDateString()
    },

    init() {
        const saved = localStorage.getItem('master_v9');
        if(saved) {
            const parsed = JSON.parse(saved);
            if(parsed.lastReset !== new Date().toLocaleDateString()) {
                this.state.lastReset = new Date().toLocaleDateString();
                this.state.subjects.forEach(s => { s.mainDone = false; s.extras = []; });
            } else {
                this.state = parsed;
            }
        }
        this.fetchVakitler();
        this.render();
        this.startClock();
    },

    async sendTelegram(msg) {
        try {
            const url = `https://api.telegram.org/bot${this.config.token}/sendMessage?chat_id=${this.config.chatId}&text=${encodeURIComponent(msg)}`;
            await fetch(url);
        } catch(e) { console.error("Telegram hatasÄ±"); }
    },

    startClock() {
        setInterval(() => {
            const now = new Date();
            const time = now.toLocaleTimeString('tr-TR', {hour12: false});
            
            if(time === "15:30:00") this.sendTelegram("ðŸ“š Ã‡alÄ±ÅŸma Vakti Geldi! Hedef 105 Soru.");
            
            Object.entries(this.state.vakitler).forEach(([name, t]) => {
                if(t + ":00" === time) this.sendTelegram(`ðŸ•Œ ${name} Vakti Girdi!`);
            });
        }, 1000);
    },

    async fetchVakitler() {
        try {
            const res = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Istanbul&country=Turkey&method=13');
            const d = await res.json();
            this.state.vakitler = { Ä°msak: d.data.timings.Fajr, Ã–ÄŸle: d.data.timings.Dhuhr, Ä°kindi: d.data.timings.Asr, AkÅŸam: d.data.timings.Maghrib, YatsÄ±: d.data.timings.Isha };
            document.getElementById('vakit-display').innerHTML = Object.entries(this.state.vakitler).map(([n, t]) => `<div>${n}<b>${t}</b></div>`).join('');
        } catch(e) {}
    },

    addSubject() {
        const n = prompt("Ders AdÄ±:");
        if(n) { this.state.subjects.push({ id: Date.now(), name: n, mainDone: false, extras: [] }); this.save(); }
    },

    toggleMain(id) {
        const s = this.state.subjects.find(x => x.id === id);
        s.mainDone = !s.mainDone;
        if(s.mainDone) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        this.save();
    },

    addExtra(id) {
        this.state.subjects.find(x => x.id === id).extras.push({ konu: '', soru: 0 });
        this.save();
    },

    updateExtra(subId, idx, field, val) {
        const s = this.state.subjects.find(x => x.id === subId);
        s.extras[idx][field] = field === 'soru' ? (parseInt(val) || 0) : val;
        this.save();
    },

    deleteExtra(subId, idx) {
        this.state.subjects.find(x => x.id === subId).extras.splice(idx, 1);
        this.save();
    },

    save() {
        localStorage.setItem('master_v9', JSON.stringify(this.state));
        this.render();
    },

    render() {
        const list = document.getElementById('subject-list');
        list.innerHTML = '';
        let total = 0;

        this.state.subjects.forEach(sub => {
            let subSum = sub.mainDone ? 35 : 0;
            sub.extras.forEach(e => subSum += e.soru);
            total += subSum;

            list.insertAdjacentHTML('beforeend', `
                <div class="subject-box ${sub.mainDone ? 'done' : ''}">
                    <div class="subject-main">
                        <span onclick="app.toggleMain(${sub.id})" style="cursor:pointer">${sub.mainDone ? 'âœ…' : 'â­•'} ${sub.name}</span>
                        <button class="btn-plus" onclick="app.addExtra(${sub.id})">+</button>
                    </div>
                    <div class="extra-list">
                        ${sub.extras.map((ex, i) => `
                            <div class="extra-item">
                                <input type="text" class="input-konu" placeholder="Konu..." value="${ex.konu}" onchange="app.updateExtra(${sub.id}, ${i}, 'konu', this.value)">
                                <input type="number" class="input-soru" value="${ex.soru}" onchange="app.updateExtra(${sub.id}, ${i}, 'soru', this.value)">
                                <button style="background:none; border:none; color:red; cursor:pointer;" onclick="app.deleteExtra(${sub.id}, ${i})">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `);
        });

        const target = this.state.subjects.length * 35;
        const p = target > 0 ? Math.round((total/target)*100) : 0;
        document.getElementById('main-bar').style.width = Math.min(p, 100) + "%";
        document.getElementById('perc-text').innerText = `%${p}`;
    }
};

app.init();
</script>
</body>
</html>
